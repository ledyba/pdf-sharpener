package main

import (
	"bytes"
	"image"
	"image/jpeg"
)

var LUT = []uint8{
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 2, 5, 8, 10, 13, 16, 18, 21, 24, 26,
	29, 32, 34, 37, 40, 42, 45, 48, 50, 53, 56, 58, 61,
	64, 66, 69, 72, 74, 77, 80, 82, 85, 88, 90, 93, 96,
	98, 101, 104, 106, 109, 112, 114, 117, 120, 122, 125, 128, 130,
	133, 136, 138, 141, 144, 146, 149, 152, 155, 157, 160, 163, 165,
	168, 171, 173, 176, 179, 182, 184, 187, 190, 192, 195, 198, 200,
	203, 206, 209, 211, 214, 217, 219, 222, 225, 227, 230, 233, 236,
	238, 241, 244, 246, 249, 252, 255, 255, 255, 255, 255, 255, 255,
	255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
	255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
	255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
	255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
	255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
	255, 255, 255, 255, 255, 255, 255, 255, 255,
}

func FilterImage(orig []byte) ([]byte, error) {
	var err error
	decoded, err := jpeg.Decode(bytes.NewReader(orig))
	if err != nil {
		return nil, err
	}
	img, ok := decoded.(*image.Gray)
	if !ok {
		return orig, nil
	}
	for idx := range img.Pix {
		img.Pix[idx] = LUT[img.Pix[idx]]
	}
	buf := bytes.Buffer{}
	err = jpeg.Encode(&buf, img, &jpeg.Options{Quality: 98})
	return buf.Bytes(), err
}
